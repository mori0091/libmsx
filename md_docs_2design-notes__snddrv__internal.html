<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libmsx: DESIGN NOTE : Internal of SNDDRV</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libmsx
   </div>
   <div id="projectbrief">C library for MSX</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2design-notes__snddrv__internal.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">DESIGN NOTE : Internal of SNDDRV</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md48"></a></p>
<p>The following sections shows the summary of internal design and specification of SNDDRV.</p>
<p>Please note that this information is for reference only and need not be a concern.</p>
<h1><a class="anchor" id="autotoc_md49"></a>
SNDDRV's sound processing pipiline</h1>
<p>SNDDRV's sound processing pipeline is consisting of 3 part of components: some <b>streamers</b>, some <b>decorders</b>, and <b>engine</b>.</p>
<ul>
<li>streamer <br  />
 A streamer streams instructions in a track, arpeggio/pitch-bend table, period table, or instrument table as an octet stream consisting of time-series data.</li>
<li>decoder <br  />
 A decoder decodes octet streams into a set of values for each tick.</li>
<li>engine <br  />
 The engine, for each tick, takes a set of values from decoder, converts / synthesis them into a set of register values, and set to registers of sound chip.</li>
</ul>
<p>Sound processing pipeline is configured for each channel of sound chip.</p>
<p>PSG (AY-3-8910) has 3 sound channels in total, so the SNDDRV configures and controls 3 sound processing pipelines for PSG.</p>
<p>An overview of SNDDRV's sound processing pipeline is shown in the figure below.</p>
<div class="fragment"><div class="line">+----------------+</div>
<div class="line">| &lt;&lt;container&gt;&gt;  |</div>
<div class="line">|   snd_Track    | ---&gt; (T streamer) --------------&gt; track data stream --------&gt; (T decoder) ---&gt; (engine) ---&gt; (sound chip)</div>
<div class="line">+----------------+         ↑    |                                                     |               ↑           i.e. PSG</div>
<div class="line">                           `----&#39; sequence control   (o) &lt;------- note on/off --------&#39;               |</div>
<div class="line">                                                         (i) &lt;--- I program change ---&#39;               |</div>
<div class="line">                                                         (a) &lt;--- A program change ---&#39;               |</div>
<div class="line">                                                         (p) &lt;--- P program change ---&#39;               |</div>
<div class="line">+----------------+                                                                                    |</div>
<div class="line">| &lt;&lt;container&gt;&gt;  |                                                                                    |</div>
<div class="line">| snd_Instrument | ---&gt; (I streamer) --------------&gt; instrument data stream ---&gt; (I decoder) ---------&#39;</div>
<div class="line">+----------------+         ↑    |                                                                     |</div>
<div class="line">                           `----&#39; sequence control                                                    |</div>
<div class="line">                           `----- note on/off ------ (o)                                              |</div>
<div class="line">                           `----- I program change ----- (i)                                          |</div>
<div class="line">+----------------+                                                                                    |</div>
<div class="line">| &lt;&lt;container&gt;&gt;  |                                                                                    |</div>
<div class="line">|  snd_PitchBend | ---&gt; (A streamer) -----------&gt; arpeggio/pitch-bend stream ---&gt; (A decoder) --------&#39;</div>
<div class="line">+----------------+         ↑    |                                                                     |</div>
<div class="line">                           `----&#39; sequence control                                                    |</div>
<div class="line">                           `----- note on/off ------ (o)                                              |</div>
<div class="line">                           `----- A program change ----- (a)                                          |</div>
<div class="line">+----------------+                                                                                    |</div>
<div class="line">| &lt;&lt;container&gt;&gt;  |                                                                                    |</div>
<div class="line">| snd_PeriodBend | ---&gt; (P streamer) -----------&gt; period modification stream ---&gt; (P decoder) --------&#39;</div>
<div class="line">+----------------+         ↑    |</div>
<div class="line">                           `----&#39; sequence control</div>
<div class="line">                           `----- note on/off ------ (o)</div>
<div class="line">                           `----- P program change ----- (p)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md50"></a>
Sound data structure</h1>
<p>The below table shows typical data types of SNDDRV and corresponding XML data type of Arkos Tracker 2 song file (.aks).</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">SNDDRV   </th><th class="markdownTableHeadNone">Arkos Tracker 2 (.aks)   </th><th class="markdownTableHeadNone">explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__SNDDRV__DATA.html#structsnd__SoundAssets" title="Container of list of musics, instruments, arpeggio tables, and period tables.">snd_SoundAssets</a>   </td><td class="markdownTableBodyNone">aks:songType   </td><td class="markdownTableBodyNone">Collection of sound assets    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">snd_PitchBend   </td><td class="markdownTableBodyNone">aks:arpeggioType   </td><td class="markdownTableBodyNone">Arpegio / Pitch-bend table    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">snd_PeriodBend   </td><td class="markdownTableBodyNone">aks:pitchType   </td><td class="markdownTableBodyNone">Period / Wavelength modification table    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="group__SNDDRV__DATA.html#structsnd__Instrument" title="Instrument (timbre) table.">snd_Instrument</a>   </td><td class="markdownTableBodyNone">aks:fmInstrumentType   </td><td class="markdownTableBodyNone">Musical instrument / Timbre    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__SNDDRV__DATA.html#structsnd__Music" title="Container of a music data.">snd_Music</a>   </td><td class="markdownTableBodyNone">aks:subsongType   </td><td class="markdownTableBodyNone">Music    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="structsnd__SpeedTrack.html" title="A special track to control speed of tracks.">snd_SpeedTrack</a>   </td><td class="markdownTableBodyNone">aks:speedTrackType   </td><td class="markdownTableBodyNone">Special track for wait tick counts.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="structsnd__EventTrack.html" title="A special track to control event trigger of tracks.">snd_EventTrack</a>   </td><td class="markdownTableBodyNone">aks:eventTrackType   </td><td class="markdownTableBodyNone">Special track for event signals.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><a class="el" href="structsnd__Track.html" title="A fragment of single channel music score.">snd_Track</a>   </td><td class="markdownTableBodyNone">aks:trackType   </td><td class="markdownTableBodyNone">A series of musical notes and effects.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a class="el" href="group__SNDDRV__DATA.html#structsnd__Pattern" title="A track pattern, that corresponds to a sub-score of a music.">snd_Pattern</a>   </td><td class="markdownTableBodyNone">aks:patternType   </td><td class="markdownTableBodyNone">Determines which track is played on which channel.   </td></tr>
</table>
<div class="fragment"><div class="line"> mermaid</div>
<div class="line">classDiagram</div>
<div class="line">snd_SoundAssets *-- &quot;0..*&quot; snd_PitchBend  : list of arpeggio tables</div>
<div class="line">snd_SoundAssets *-- &quot;0..*&quot; snd_PeriodBend : list of period tables</div>
<div class="line">snd_SoundAssets *-- &quot;1..*&quot; snd_Instrument : list of timbres</div>
<div class="line">snd_SoundAssets *-- &quot;1..*&quot; snd_Music      : list of musics</div>
<div class="line"> </div>
<div class="line">snd_Music *-- &quot;0..*&quot; snd_SpeedTrack : speedTracks</div>
<div class="line">snd_Music *-- &quot;0..*&quot; snd_EventTrack : eventTracks</div>
<div class="line">snd_Music *-- &quot;1..*&quot; snd_Track      : tracks</div>
<div class="line">snd_Music *-- &quot;1..*&quot; snd_Pattern    : pattern sequence</div>
<div class="line"> </div>
<div class="line">snd_SpeedTrack &quot;1&quot; &lt;.. snd_Pattern : refers by index</div>
<div class="line">snd_EventTrack &quot;1&quot; &lt;.. snd_Pattern : refers by index</div>
<div class="line">snd_Track      &quot;3&quot; &lt;.. snd_Pattern : refers by index</div>
<div class="line"> </div>
<div class="line">snd_PitchBend  &lt;.. snd_Track : refers by index</div>
<div class="line">snd_PeriodBend &lt;.. snd_Track : refers by index</div>
<div class="line">snd_Instrument &lt;.. snd_Track : refers by index</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md51"></a>
Sound data format notation</h1>
<p>Here is the notation for defining our sound data format. <br  />
 This notation itself is described in BNF notation. </p><pre class="fragment">&lt;term&gt; := &lt;identifier&gt;        ; name of a variable
        | &lt;term&gt; &lt;term&gt;       ; sequence of &lt;term&gt;
        | '(' &lt;term&gt; ')'      ; group of &lt;term&gt;
        | &lt;term&gt; '|' &lt;term&gt;   ; left-hand &lt;term&gt; or right-hand &lt;term&gt;
        | &lt;term&gt; '?'          ; 0 or 1 &lt;term&gt;
        | &lt;term&gt; '*'          ; 0 or more &lt;term&gt;
        | &lt;term&gt; '+'          ; 1 or more &lt;term&gt;
        | &lt;term&gt; '{' &lt;n&gt; '}'  ; &lt;n&gt; times repetition of &lt;term&gt;
        | &lt;bits&gt; 'b'          ; A binary such as "1001b"
        | &lt;term&gt; ':' &lt;k&gt;      ; &lt;term&gt; that is a &lt;k&gt; bit binary

&lt;bits&gt; := &lt;bit&gt;
        | &lt;bit&gt; &lt;bits&gt;

&lt;bit&gt;  := '0'                 ; 1 bit zero
        | '1'                 ; 1 bit one
        | '_'                 ; 1 bit wildcard
</pre><h1><a class="anchor" id="autotoc_md52"></a>
Definition of Sound data</h1>
<h2><a class="anchor" id="autotoc_md53"></a>
Definition of SpeedTrack stream</h2>
<p>(snip)</p>
<h2><a class="anchor" id="autotoc_md54"></a>
Definition of EventTrack stream</h2>
<p>(snip)</p>
<h2><a class="anchor" id="autotoc_md55"></a>
Definition of Track stream</h2>
<p>The following is the sound data format for <b>track streams</b> written in the notation defined in the previous section.</p>
<h3><a class="anchor" id="autotoc_md56"></a>
Track stream</h3>
<div class="fragment"><div class="line">; Track stream</div>
<div class="line">t_stream   := t_line*</div>
<div class="line"> </div>
<div class="line">; A line of track</div>
<div class="line">t_line     := t_chunk* EOL</div>
<div class="line"> </div>
<div class="line">; end mark of line, and number of lines to be skipped.</div>
<div class="line">EOL        := 110b l:5            ; l: number of lines to be skipped (0..31)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md57"></a>
Chunk of Track stream</h3>
<div class="fragment"><div class="line">; A chunk of track stream</div>
<div class="line">t_chunk    := RST                 ; stops the sound of the instrument.</div>
<div class="line">            | Note                ; a note command</div>
<div class="line">            | Exprs               ; expressions</div>
<div class="line"> </div>
<div class="line">RST        := 1110b _:4           ; reset effect and set volume to 0</div>
<div class="line"> </div>
<div class="line">Note       := NoteOff             ; key off</div>
<div class="line">            | NoteOn              ; key on</div>
<div class="line">            | Legato              ; switch note w/o key on</div>
<div class="line"> </div>
<div class="line">   NoteOff := 0:8</div>
<div class="line">   NoteOn  := 0b n:7 i:8          ; n: note # (1..127), i: instrument # (1..255)</div>
<div class="line">   Legato  := 0b n:7 0:8          ; n: note # (1..127)</div>
<div class="line"> </div>
<div class="line">Exprs      := 10_0b n:4 expr{n+1} ; n: number of expressions - 1</div>
<div class="line"> </div>
<div class="line">   expr    := 0000b x:4           ; reset effect and set volume to 15-x</div>
<div class="line">            | 0001b x:4 y:4 _:4   ; arpeggio 3 notes (note +0, +x, +y)</div>
<div class="line">            | 0010b x:4 y:4 z:4   ; arpeggio 4 notes (note +0, +x, +y, +z)</div>
<div class="line">            | 0011b x:4 y:4 z:4   ; pitch up         (period -xyz/256 for each ticks)</div>
<div class="line">            | 0100b x:4 y:4 z:4   ; pitch down       (period +xyz/256 for each ticks)</div>
<div class="line">            | 0101b x:4 y:4 z:4   ; fast pitch up    (period -xyz/16 for each tick)</div>
<div class="line">            | 0110b x:4 y:4 z:4   ; fast pitch down  (period +xyz/16 for each tick)</div>
<div class="line">            | 0111b x:4 y:4 z:4   ; pitch glide      (pitch ±1 for each xyz+1 ticks)</div>
<div class="line">            | 1000b x:4           ; set volume to x  (volume ← x)</div>
<div class="line">            | 1001b x:4 y:4 z:4   ; fade in          (volume +xyz/128 for each ticks)</div>
<div class="line">            | 1010b x:4 y:4 z:4   ; fade out         (volume -xyz/128 for each ticks)</div>
<div class="line">            | 1011b x:4 y:4 _:4   ; force the speed of an instrument (1 step for each xy+1 ticks)</div>
<div class="line">            | 1100b x:4 y:4 _:4   ; force the speed of an arpeggio / pitch-bend table (1 step for each xy+1 ticks)</div>
<div class="line">            | 1101b x:4 y:4 _:4   ; force the speed of a period / wavelength table (1 step for each xy+1 ticks)</div>
<div class="line">            | 1110b x:4 y:4 _:4   ; set arpeggio / pitch-bend table # to xy (1..255) or turn off (xy = 0)</div>
<div class="line">            | 1111b x:4 y:4 _:4   ; set period / wavelength table # to xy (1..255) or turn off (xy = 0)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md58"></a>
Definition of Pattern table</h2>
<p>(snip)</p>
<h1><a class="anchor" id="autotoc_md59"></a>
Definition of Instrument (timbre) table</h1>
<div class="fragment"><div class="line">; list of instrument tables</div>
<div class="line">i_tables := address_of_i_table+</div>
<div class="line"> </div>
<div class="line">; an instrument table</div>
<div class="line">i_table  := address_of_AD_part</div>
<div class="line">            address_of_S_part</div>
<div class="line">            address_of_R_part</div>
<div class="line">AD_part  := i_chunk* EOM          ; Attack to Decay phase</div>
<div class="line">S_part   := i_chunk* EOM          ; Sustain phase</div>
<div class="line">R_part   := i_chunk* EOM          ; Release phase</div>
<div class="line"> </div>
<div class="line">i_chunk  := N? Ps? (V | (R? Ph? H))</div>
<div class="line">EOM      := 11111111b</div>
<div class="line"> </div>
<div class="line">; Volume</div>
<div class="line">V  := _:3 v:4 0b                  ; (___vvvv0) v = volume (0..15)</div>
<div class="line"> </div>
<div class="line">; Noise generator and Mixer</div>
<div class="line">N  := n:5 t:1 01b                 ; (nnnnnt01) n = noise (0..31), t = mix_tone?</div>
<div class="line"> </div>
<div class="line">; Hardware envelope and Modulation type</div>
<div class="line">H  := w:3 m:2 011b                ; (wwmmT011) w = waveform, m = modulation</div>
<div class="line">  ; Waveform of hardware envelope</div>
<div class="line">  w := 000b ; ( 8) ◣◣◣◣ Saw tooth</div>
<div class="line">    |  001b ; ( 9) ◣___</div>
<div class="line">    |  010b ; (10) ◣◢◣◢ Triangle</div>
<div class="line">    |  011b ; (11) ◣■■■</div>
<div class="line">    |  100b ; (12) ◢◢◢◢ Inverse Saw tooth</div>
<div class="line">    |  101b ; (13) ◢■■■</div>
<div class="line">    |  110b ; (14) ◢◣◢◣ Inverse Triangle</div>
<div class="line">    |  111b ; (15) ◢___</div>
<div class="line">  ; Modulation type</div>
<div class="line">  m := 00b ; Hard only</div>
<div class="line">    |  01b ; Soft to Hard</div>
<div class="line">    |  10b ; Hard to Soft</div>
<div class="line">    |  11b ; Soft and Hard</div>
<div class="line"> </div>
<div class="line">; Coefficients used in wavelength calculations for square wave and hardware envelope modulation.</div>
<div class="line">R  := r:3 T:1 0111b                           ; (rrrT0111) r = ratio (0..7), T = retrigger?</div>
<div class="line">  ; Ratio</div>
<div class="line">  ;    hw_period = sw_period &gt;&gt; r   if modulation type is &quot;soft to hard&quot;</div>
<div class="line">  ;    sw_period = hw_period &lt;&lt; r   if modulation type is &quot;hard to soft&quot;</div>
<div class="line">  ;    r is unused                  otherwise</div>
<div class="line">  ; Retrigger?</div>
<div class="line">  T := 0 ; do not restart hardware envelope if its waveform is same as before.</div>
<div class="line">    |  1 ; force to restart hardware envelope.</div>
<div class="line"> </div>
<div class="line">Ps := _00b 01111b period:16</div>
<div class="line">   |  _01b 01111b period_delta:16</div>
<div class="line">   |  _10b 01111b pitch_delta:16</div>
<div class="line">   |  _11b 01111b period_delta:16 pitch_delta:16</div>
<div class="line"> </div>
<div class="line">Ph := 00b 011111b period:16</div>
<div class="line">   |  01b 011111b period_delta:16</div>
<div class="line">   |  10b 011111b pitch_delta:16</div>
<div class="line">   |  11b 011111b period_delta:16 pitch_delta:16</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
