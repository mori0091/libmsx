// -*- coding: utf-8-unix -*-
/**
 * \file snddrv_demo.c
 *
 * Copyright (c) 2022 Daishi Mori (mori0091)
 *
 * This software is released under the MIT License.\n
 * See https://github.com/mori0091/libmsx/blob/main/LICENSE
 *
 * GitHub libmsx project\n
 * https://github.com/mori0091/libmsx
 */

#include <msx.h>
#include <snddrv.h>
#include <snd_i_table.h>

#define ARRAY_SIZEOF(a)    (sizeof(a) / sizeof(a[0]))

static const uint8_t i_table_01_a[] = {
  0x1e, 0x1c, 0x1a, 0x18, 0x16, 0x14, 0x12,
  /* 0xff, */
};
static const uint8_t i_table_01_s[] = {
  0x10,
  0xff,
};
static const uint8_t i_table_01_r[] = {
  0x0e, 0x0c, 0x0a, 0x08, 0x06, 0x04, 0x02, 0x00,
  0xff,
};

static const uint8_t i_table_02_a[] = {
  0x1e, 0x1c, 0x1a, 0x18, 0x16, 0x14, 0x12, 0x10,
  0x0e, 0x0c, 0x0a, 0x08, 0x06, 0x04, 0x02, 0x00,
};
static const uint8_t i_table_02_s[] = {
  0xff,
};

static const struct snd_i_table i_tables[] = {
  // instrument #1
  [0] = { 1, i_table_01_a, i_table_01_s, i_table_01_r, },
  // instrument #2
  [1] = { 4, i_table_02_a, i_table_02_s, i_table_02_s, },
};

// ---- Sound effects ----
const uint8_t sfx[] = {
//ch0            ch1            ch3            wait  // ch0     ch1      ch2
                 0xc1, 2,
                 0xe1, 0x8f,
                 0x81, 83,                     0x03,
                 0x81, 88,                     0x20,

  0xff,
};

// ---- Background music ----

const uint8_t bgm[] = {
//ch0            ch1            ch3            wait  // ch0     ch1      ch2
  // A part (1/2)
  0xe0, 0x8f,    0xe1, 0x8f,    0xe2, 0x8f,          // V15     V15      V15

  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x3e,    0x81, 0x42,    0x82, 0x45,    0x0a, // D4      F#4      A4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3e,    0x81, 0x42,    0x82, 0x45,    0x0a, // D4      F#4      A4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x37,    0x81, 0x3b,    0x82, 0x3e,          // G3      B3       D4      T180 L4
  0xe0, 0xa0, 4, 0xe1, 0xa0, 4, 0xe2, 0xa0, 4, 0x0a, // fade out
  0xe0, 0x90, 2, 0xe1, 0x90, 2, 0xe2, 0x90, 2, 0x02, // fade in
  0xe0, 0xa0, 2, 0xe1, 0xa0, 2, 0xe2, 0xa0, 2, 0x02, // fade out
  0xe0, 0x90, 1, 0xe1, 0x90, 1, 0xe2, 0x90, 1, 0x01, // fade in
  0xe0, 0xa0, 1, 0xe1, 0xa0, 1, 0xe2, 0xa0, 1, 0x01, // fade out

                                               0x14, // R       R        R

  // A part (2/2)
  0xe0, 0x8f,    0xe1, 0x8f,    0xe2, 0x8f,          // V15     V15      V15

  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x3e,    0x81, 0x42,    0x82, 0x45,    0x0a, // D4      F#4      A4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3e,    0x81, 0x42,    0x82, 0x45,    0x0a, // D4      F#4      A4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x3c,    0x81, 0x40,    0x82, 0x43,    0x0a, // C4      E4       G4      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x37,    0x81, 0x3b,    0x82, 0x3e,          // G3      B3       D4      T180 L4
  0xe0, 0xa0, 4, 0xe1, 0xa0, 4, 0xe2, 0xa0, 4, 0x0a, // fade out
  0xe0, 0x90, 2, 0xe1, 0x90, 2, 0xe2, 0x90, 2, 0x02, // fade in
  0xe0, 0xa0, 2, 0xe1, 0xa0, 2, 0xe2, 0xa0, 2, 0x02, // fade out
  0xe0, 0x90, 1, 0xe1, 0x90, 1, 0xe2, 0x90, 1, 0x01, // fade in
  0xe0, 0xa0, 1, 0xe1, 0xa0, 1, 0xe2, 0xa0, 1, 0x01, // fade out

                                               0x14, // R       R        R

  // B part (1/2)
  0xe0, 0x8c,    0xe1, 0x8c,    0xe2, 0x8c,          // V12     V12      V12

  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x30,    0x81, 0x34,    0x82, 0x37,    0x0a, // C3      E3       G3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x30,    0x81, 0x34,    0x82, 0x37,    0x0a, // C3      E3       G3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x37,    0x81, 0x3b,    0x82, 0x3e,          // G3      B3       D4      T180 L4
  0xe0, 0xa0, 4, 0xe1, 0xa0, 4, 0xe2, 0xa0, 4, 0x0a, // fade out
  0xe0, 0x90, 2, 0xe1, 0x90, 2, 0xe2, 0x90, 2, 0x02, // fade in
  0xe0, 0xa0, 2, 0xe1, 0xa0, 2, 0xe2, 0xa0, 2, 0x02, // fade out
  0xe0, 0x90, 1, 0xe1, 0x90, 1, 0xe2, 0x90, 1, 0x01, // fade in
  // 0xe0, 0xa0, 1, 0xe1, 0xa0, 1, 0xe2, 0xa0, 1, 0x02, // fade out

                                               0x14, // R       R        R

  // B part (2/2)
  0xe0, 0x8c,    0xe1, 0x8c,    0xe2, 0x8c,          // V12     V12      V12

  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x30,    0x81, 0x34,    0x82, 0x37,    0x0a, // C3      E3       G3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x30,    0x81, 0x34,    0x82, 0x37,    0x0a, // C3      E3       G3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off
  0x80, 0x32,    0x81, 0x36,    0x82, 0x39,    0x0a, // D3      F#3      A3      T180 L4
  0x90,          0x91,          0x92,          0x0a, // Off     Off      Off

  0x80, 0x37,    0x81, 0x3b,    0x82, 0x3e,          // G3      B3       D4      T180 L4
  0xe0, 0xa0, 4, 0xe1, 0xa0, 4, 0xe2, 0xa0, 4, 0x0a, // fade out
  0xe0, 0x90, 2, 0xe1, 0x90, 2, 0xe2, 0x90, 2, 0x02, // fade in
  0xe0, 0xa0, 2, 0xe1, 0xa0, 2, 0xe2, 0xa0, 2, 0x02, // fade out
  0xe0, 0x90, 1, 0xe1, 0x90, 1, 0xe2, 0x90, 1, 0x01, // fade in
  // 0xe0, 0xa0, 1, 0xe1, 0xa0, 1, 0xe2, 0xa0, 1, 0x02, // fade out

                                               0x14, // R       R        R

  0xff,
};

_Noreturn
static void infinite_loop(void) {
  bool old_fired = false;
  for (;;) {
    // await_vsync();
    // Is SPACE key pressed ?
    bool fired = joypad_get_state(0) & VK_FIRE_0;
    if (!old_fired && fired) {
      // sound effects "coiiiiiiin!"
      snd_set_sfx((void *)sfx);
    }
    old_fired = fired;
  }
}

void main(void) {
  // Turn key-click beep off.
  CLIKSW = 0;
  // Initialize the sound driver.
  // This must be called once at least, before the snd_play() is called.
  snd_init();

  // Register instruments (timbre) table.
  snd_set_i_tables(ARRAY_SIZEOF(i_tables), i_tables);

  // Register the sound driver as VSYNC handler.
  set_vsync_handler(snd_play);

  snd_set_repeat(true);
  snd_set_speed(SND_SPEED_1X * 1); // 2x
  snd_set_bgm((void *)bgm);     // Register the BGM to be played.
  snd_start();                  // Start the BGM.

  infinite_loop();
}
